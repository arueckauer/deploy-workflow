name: Update PHP Dependencies

on:
  schedule:
    - cron: '04 6 * * 4' # 06:30 CET (UTC+1) â†’ 05:30 UTC in summer, 04:30 UTC in winter
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    env:
      GIT_AUTHOR_NAME: GitHub Actions
      GIT_AUTHOR_EMAIL: actions@github.com
      GIT_COMMITTER_NAME: GitHub Actions
      GIT_COMMITTER_EMAIL: actions@github.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          ini-values: date.timezone=Europe/Zurich

      - name: Update dependencies in main app
        run: composer u -W && composer bump && composer u --lock
        working-directory: .

      - name: Generate main app diff
        id: main_diff
        run: |
          git diff composer.json > main.diff
          php .github/workflows/diff-2-commit-message-entry.php main.diff > main.changelog

      - name: Generate PR message
        run: cat .github/workflows/pr-message-template.txt main.changelog > pr-message.txt

      - name: Clean up temp files
        run: |
          rm -f main.changelog main.diff
          rm -rf vendor

      - name: Commit main app changes
        run: |
          if git diff --quiet composer.json composer.lock; then
            echo "No changes in main app"
          else
            git add composer.json composer.lock
            git commit -m "$(cat .github/workflows/commit-message-template.txt; cat main.changelog)"
          fi

      - name: Push changes
        run: |
          git push origin HEAD:update-deps-$(date +'%Y%m%d')

      - name: Set DATE env
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: update-deps-${{ env.DATE }}
          title: "Chore: PHP dependencies update (${{ env.DATE }})"
          body-path: pr-message.txt
          reviewers: arueckauer
          labels: dependencies

      - name: Remove PR message file
        run: rm -f pr-message.txt
